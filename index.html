<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZingMp3 API - Nghe nh·∫°c Online</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      background: linear-gradient(135deg, #0b1020 0%, #1a1f3a 100%); 
      color: #e5e7eb; 
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0 0 24px; font-size: 28px; color: #60a5fa; text-align: center; }
    .card { 
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%); 
      border: 1px solid #374151; 
      border-radius: 16px; 
      padding: 24px; 
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    label { display: block; margin-bottom: 8px; color: #93c5fd; font-weight: 500; }
    input[type="text"] { 
      width: 100%; 
      padding: 12px 16px; 
      border-radius: 10px; 
      border: 1px solid #374151; 
      background: #0f172a; 
      color: #e5e7eb;
      font-size: 14px;
      transition: border 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
    }
    button { 
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
      color: white; 
      border: 0; 
      border-radius: 10px; 
      padding: 12px 20px; 
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 14px;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; align-items: end; }
    pre { 
      background: #0f172a; 
      color: #d1d5db; 
      padding: 16px; 
      border-radius: 12px; 
      overflow: auto; 
      max-height: 400px;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #1f2937;
    }
    .group-title { 
      color: #fcd34d; 
      font-weight: 700; 
      margin-bottom: 16px; 
      font-size: 18px;
      border-bottom: 2px solid #374151;
      padding-bottom: 8px;
    }
    /* Audio Player Styling */
    audio { 
      width: 100%; 
      margin-top: 16px;
      border-radius: 10px;
      background: #f1f5f9; /* M√†u s√°ng ƒë·ªÉ d·ªÖ nh√¨n control */
    }
    .hidden { display: none; }
    #direct128 { 
      color: #60a5fa; 
      word-break: break-all;
      display: inline-block;
      margin-top: 12px;
      padding: 10px;
      background: #0f172a;
      border-radius: 8px;
      text-decoration: none;
      font-size: 12px;
    }
    #direct128:hover {
      color: #93c5fd;
      background: #1e293b;
    }
    small { 
      color: #9ca3af; 
      display: block; 
      margin-top: 8px;
      font-size: 12px;
    }
    .player-info {
      background: #1e293b;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
      border-left: 4px solid #2563eb;
    }
    .player-info h3 {
      color: #60a5fa;
      margin-bottom: 6px;
      font-size: 16px;
    }
    .error {
      background: #450a0a;
      color: #fca5a5;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      border: 1px solid #7f1d1d;
    }
    .success {
      background: #064e3b;
      color: #6ee7b7;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ ZingMp3 API - Nghe nh·∫°c Online</h1>

    <div class="card">
      <div class="group-title">1. T√¨m ki·∫øm b√†i h√°t</div>
      <div class="row">
        <div>
          <label>T√™n b√†i h√°t, ca sƒ©...</label>
          <input id="kw" type="text" placeholder="V√≠ d·ª•: s∆°n t√πng, ch√∫ng ta c·ªßa hi·ªán t·∫°i..." />
        </div>
        <div>
          <button id="btnSearchV2">üîç T√¨m ki·∫øm</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="group-title">2. Tr√¨nh ph√°t nh·∫°c (Proxy Server)</div>
      <div class="row">
        <div>
          <label>Song ID</label>
          <input id="songId" type="text" placeholder="V√≠ d·ª•: ZOACFBBU" />
        </div>
        <div style="display:flex; gap:8px; flex-wrap: wrap;">
          <button id="btnPlay">‚ñ∂Ô∏è Ph√°t nh·∫°c</button>
          <button id="btnGetLink" style="background: #4b5563;">üîó JSON Link</button>
          <button id="btnInfoSong" style="background: #4b5563;">‚ÑπÔ∏è Info</button>
          <button id="btnLyric" style="background: #4b5563;">üìù Lyric</button>
        </div>
      </div>
      
      <div id="playerSection" class="hidden">
        <div class="player-info">
          <h3 id="nowPlaying">ƒêang t·∫£i th√¥ng tin...</h3>
          <span id="artistPlaying"></span>
        </div>
        
        <audio id="player" controls crossorigin="anonymous" autoplay></audio>
        
        <a id="direct128" class="hidden" target="_blank" rel="noreferrer noopener">üîó Link ph√°t tr·ª±c ti·∫øp</a>
        <small id="note128" class="hidden">Link n√†y ch·∫°y qua proxy server ƒë·ªÉ bypass ch·∫∑n v√πng (Geo-blocking).</small>
      </div>
      
      <div id="errorMsg" class="error hidden"></div>
    </div>

    <div class="card">
      <label>üìä K·∫øt qu·∫£ JSON / Debug</label>
      <pre id="out">(ch∆∞a c√≥ d·ªØ li·ªáu)</pre>
    </div>
  </div>

  <script>
    const out = document.getElementById('out');
    const player = document.getElementById('player');
    const playerSection = document.getElementById('playerSection');
    const direct128 = document.getElementById('direct128');
    const note128 = document.getElementById('note128');
    const nowPlaying = document.getElementById('nowPlaying');
    const artistPlaying = document.getElementById('artistPlaying');
    const errorMsg = document.getElementById('errorMsg');

    // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ JSON
    const setOut = (d) => {
      out.textContent = typeof d === 'string' ? d : JSON.stringify(d, null, 2);
    };

    // H√†m hi·ªÉn th·ªã l·ªói
    const showError = (msg) => {
      errorMsg.textContent = msg;
      errorMsg.classList.remove('hidden');
      // T·ª± t·∫Øt sau 10s
      setTimeout(() => errorMsg.classList.add('hidden'), 10000);
    };

    // H√†m g·ªçi API c∆° b·∫£n
    async function call(path, params) {
      const url = new URL(path, window.location.origin);
      if (params) {
        Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      }
      console.log('Calling:', url.toString());
      const res = await fetch(url);
      const text = await res.text();
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return JSON.parse(text);
    }

    // --- LOGIC T√åM KI·∫æM ---
    document.getElementById('btnSearchV2').onclick = async () => {
      const q = document.getElementById('kw').value.trim();
      if (!q) return showError('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a!');
      
      setOut('‚è≥ ƒêang t√¨m ki·∫øm...');
      try {
        const res = await call('/api/search', { q });
        const songs = res?.data?.songs || [];
        
        if (songs.length > 0) {
          // T·ª± ƒëi·ªÅn ID b√†i ƒë·∫ßu ti√™n
          document.getElementById('songId').value = songs[0].encodeId;
          
          // Format k·∫øt qu·∫£ cho g·ªçn
          const concise = songs.map(s => ({
            id: s.encodeId,
            title: s.title,
            artist: s.artistsNames,
            duration: s.duration
          }));
          
          setOut({ 
            msg: `‚úÖ T√¨m th·∫•y ${songs.length} b√†i. ƒê√£ ƒëi·ªÅn ID b√†i ƒë·∫ßu ti√™n.`,
            results: concise 
          });
        } else {
          setOut('‚ùå Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o.');
        }
      } catch (e) {
        setOut('L·ªói t√¨m ki·∫øm: ' + e.message);
      }
    };

    // --- LOGIC PH√ÅT NH·∫†C (QUAN TR·ªåNG) ---
    document.getElementById('btnPlay').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Song ID');
      
      // Reset giao di·ªán
      player.pause();
      player.src = "";
      errorMsg.classList.add('hidden');
      playerSection.classList.remove('hidden');
      nowPlaying.textContent = "‚è≥ ƒêang t·∫£i th√¥ng tin...";
      artistPlaying.textContent = "";
      setOut('‚è≥ ƒêang x·ª≠ l√Ω y√™u c·∫ßu ph√°t nh·∫°c...');

      try {
        // 1. L·∫•y th√¥ng tin b√†i h√°t ƒë·ªÉ hi·ªÉn th·ªã t√™n
        call('/api/info-song', { id }).then(info => {
          if(info.data) {
             nowPlaying.textContent = "üéµ " + (info.data.title || 'Unknown');
             artistPlaying.textContent = "üé§ " + (info.data.artistsNames || 'Unknown');
          }
        }).catch(err => console.error("L·ªói l·∫•y info:", err));

        // 2. G·ªçi th·∫≥ng v√†o Proxy Server
        // Server s·∫Ω t·ª± lo vi·ªác l·∫•y link th·∫≠t v√† stream v·ªÅ
        const proxyUrl = `/api/song/stream?id=${id}`; // Kh√¥ng c·∫ßn encodeURIComponent n·∫øu ID chu·∫©n
        
        console.log('Proxy URL:', proxyUrl);
        
        // G√°n link v√†o player
        player.src = proxyUrl;
        
        // Hi·ªÉn th·ªã link backup
        direct128.href = proxyUrl;
        direct128.textContent = 'üîó ' + window.location.origin + proxyUrl;
        direct128.classList.remove('hidden');
        note128.classList.remove('hidden');

        setOut({
          status: 'streaming',
          message: 'ƒêang stream nh·∫°c qua Proxy Server...',
          songId: id,
          url: proxyUrl
        });

      } catch (e) {
        showError('L·ªói kh·ªüi t·∫°o: ' + e.message);
      }
    };

    // B·∫Øt l·ªói tr·ª±c ti·∫øp tr√™n th·∫ª Audio (r·∫•t quan tr·ªçng cho stream)
    player.onerror = () => {
      const err = player.error;
      // N·∫øu user ch∆∞a b·∫•m play ho·∫∑c src r·ªóng th√¨ b·ªè qua
      if(!player.src) return;

      let msg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
      if (err.code === 1) msg = 'Ng∆∞·ªùi d√πng ƒë√£ h·ªßy t·∫£i.';
      if (err.code === 2) msg = 'L·ªói m·∫°ng khi t·∫£i stream.';
      if (err.code === 3) msg = 'L·ªói gi·∫£i m√£ (Decode Error).';
      if (err.code === 4) msg = 'Kh√¥ng th·ªÉ ph√°t (Link l·ªói ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£).';
      
      console.error('Audio Error:', err);
      showError(`‚ùå L·ªói Player: ${msg}`);
      setOut({ error: 'Player Error', code: err.code, message: msg });
    };

    // --- C√ÅC N√öT KH√ÅC ---
    
    // L·∫•y JSON Link
    document.getElementById('btnGetLink').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return;
      try {
        const res = await call('/api/song', { id });
        setOut(res);
      } catch(e) { setOut(e.message); }
    };

    // L·∫•y Info
    document.getElementById('btnInfoSong').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return;
      try {
        const res = await call('/api/info-song', { id });
        setOut(res);
      } catch(e) { setOut(e.message); }
    };

    // L·∫•y Lyric
    document.getElementById('btnLyric').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return;
      try {
        setOut('‚è≥ ƒêang t·∫£i l·ªùi b√†i h√°t...');
        const res = await call('/api/lyric', { id });
        const fileUrl = res?.data?.file;
        
        if (fileUrl) {
          // Fetch n·ªôi dung file lrc
          const lrcRes = await fetch(fileUrl);
          const lrcText = await lrcRes.text();
          setOut(lrcText); // Hi·ªÉn th·ªã n·ªôi dung text
        } else {
          setOut(res);
        }
      } catch(e) { setOut(e.message); }
    };

    // Enter Key Support
    document.getElementById('kw').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnSearchV2').click();
    });
    document.getElementById('songId').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnPlay').click();
    });
  </script>
</body>
</html>
